<?php
/**
 * Controlador de administraci√≥n de exposiciones
 * 
 * Maneja todas las operaciones CRUD para exposiciones en el panel administrativo,
 * incluyendo validaciones, mensajes flash y verificaci√≥n de permisos.
 * 
 * @author Sistema de Gesti√≥n de Exposiciones
 * @version 1.0
 */

namespace Controladores;

use Exception;
use Modelos\Exposicion;
use Modelos\Usuario;

/**
 * Clase AdminExposicionControlador
 * 
 * Controlador especializado en la gesti√≥n administrativa de exposiciones
 */
class AdminExposicionControlador extends ControladorBase {
    
    /**
     * Muestra la lista paginada de exposiciones
     * 
     * @param int $pagina N√∫mero de p√°gina para la paginaci√≥n
     * @return void
     */
    public function listar(int $pagina = 1): void {
        try {
            $this->verificarAutenticacion();
            $this->verificarPermiso('exposiciones.listar');
            
            $exposicionModelo = new Exposicion();
            $limite = 10;
            $offset = ($pagina - 1) * $limite;
            
            // Obtener exposiciones con informaci√≥n del creador
            $exposiciones = $exposicionModelo->obtenerConCreador([], $limite, $offset);
            $totalExposiciones = $exposicionModelo->contarTodos();
            $totalPaginas = ceil($totalExposiciones / $limite);
            
            $datos = [
                'exposiciones' => $exposiciones,
                'paginaActual' => $pagina,
                'totalPaginas' => $totalPaginas,
                'totalExposiciones' => $totalExposiciones
            ];
            
            $this->renderizar('admin/exposiciones/listar', $datos);
            
        } catch (Exception $e) {
            $this->a√±adirMensajeFlash('error', '‚ùå Error al cargar exposiciones: ' . $e->getMessage());
            $this->redirigir('/admin');
        }
    }
    
    /**
     * Muestra el formulario para crear una nueva exposici√≥n
     * 
     * @return void
     */
    public function mostrarCrear(): void {
        try {
            $this->verificarAutenticacion();
            $this->verificarPermiso('exposiciones.crear');
            
            // Obtener categor√≠as disponibles
            $categorias = $this->obtenerCategoriasExposicion();
            
            $datos = [
                'categorias' => $categorias,
                'accion' => 'crear'
            ];
            
            $this->renderizar('admin/exposiciones/crear', $datos);
            
        } catch (Exception $e) {
            $this->a√±adirMensajeFlash('error', '‚ùå Error al mostrar formulario: ' . $e->getMessage());
            $this->redirigir('/admin/exposiciones');
        }
    }
    
    /**
     * Procesa la creaci√≥n de una nueva exposici√≥n
     * 
     * @return void
     */
    public function procesarCrear(): void {
        try {
            $this->verificarAutenticacion();
            $this->verificarPermiso('exposiciones.crear');
            
            // Obtener datos del formulario
            $datos = $this->obtenerDatosFormulario([
                'titulo',
                'descripcion',
                'descripcion_corta',
                'categoria',
                'ubicacion', 
                'direccion_completa',
                'fecha_inicio',
                'fecha_fin',
                'precio_entrada',
                'imagen_principal',
                'video_promocional',
                'enlace_compra',
                'destacada',
                'activa',
                'visible'
            ]);
            
            // Validar datos
            $this->validarDatosExposicion($datos);
            
            // Agregar datos adicionales
            $datos['slug'] = $this->generarSlug($datos['titulo']);
            $datos['usuario_creador_id'] = $_SESSION['usuario_id'];
            $datos['destacada'] = isset($datos['destacada']) ? 1 : 0;
            $datos['activa'] = isset($datos['activa']) ? 1 : 0;
            $datos['visible'] = isset($datos['visible']) ? 1 : 0;
            
            // Crear exposici√≥n
            if ($this->crearExposicion($datos)) {
                $this->a√±adirMensajeFlash('exito', "‚úÖ Exposici√≥n '{$datos['titulo']}' creada exitosamente");
                $this->a√±adirMensajeFlash('info', "üèõÔ∏è Ubicaci√≥n: {$datos['ubicacion']} | üìÖ Desde: {$datos['fecha_inicio']}");
                $this->redirigir('/admin/exposiciones');
            } else {
                throw new Exception('No se pudo crear la exposici√≥n en la base de datos');
            }
            
        } catch (Exception $e) {
            $this->a√±adirMensajeFlash('error', '‚ùå Error al crear exposici√≥n: ' . $e->getMessage());
            $this->redirigir('/admin/exposiciones/crear');
        }
    }
    
    /**
     * Muestra el formulario para editar una exposici√≥n existente
     * 
     * @param int $id ID de la exposici√≥n a editar
     * @return void
     */
    public function mostrarEditar(int $id): void {
        try {
            $this->verificarAutenticacion();
            $this->verificarPermiso('exposiciones.editar');
            
            $exposicionModelo = new Exposicion();
            $exposicion = $exposicionModelo->obtenerPorId($id);
            
            if (!$exposicion) {
                throw new Exception('Exposici√≥n no encontrada');
            }
            
            $categorias = $this->obtenerCategoriasExposicion();
            
            $datos = [
                'exposicion' => $exposicion,
                'categorias' => $categorias,
                'accion' => 'editar'
            ];
            
            $this->renderizar('admin/exposiciones/editar', $datos);
            
        } catch (Exception $e) {
            $this->a√±adirMensajeFlash('error', '‚ùå Error al cargar exposici√≥n: ' . $e->getMessage());
            $this->redirigir('/admin/exposiciones');
        }
    }
    
    /**
     * Procesa la actualizaci√≥n de una exposici√≥n
     * 
     * @param int $id ID de la exposici√≥n a actualizar
     * @return void
     */
    public function procesarEditar(int $id): void {
        try {
            $this->verificarAutenticacion();
            $this->verificarPermiso('exposiciones.editar');
            
            // Verificar que la exposici√≥n existe
            $exposicionModelo = new Exposicion();
            $exposicionExistente = $exposicionModelo->obtenerPorId($id);
            
            if (!$exposicionExistente) {
                throw new Exception('Exposici√≥n no encontrada');
            }
            
            // Obtener datos del formulario
            $datos = $this->obtenerDatosFormulario([
                'titulo',
                'descripcion',
                'descripcion_corta',
                'categoria',
                'ubicacion',
                'direccion_completa',
                'fecha_inicio',
                'fecha_fin',
                'precio_entrada',
                'imagen_principal',
                'video_promocional',
                'enlace_compra',
                'destacada',
                'activa',
                'visible'
            ]);
            
            // Validar datos
            $this->validarDatosExposicion($datos, $id);
            
            // Actualizar slug si cambi√≥ el t√≠tulo
            if ($datos['titulo'] !== $exposicionExistente['titulo']) {
                $datos['slug'] = $this->generarSlug($datos['titulo']);
            }
            
            $datos['destacada'] = isset($datos['destacada']) ? 1 : 0;
            $datos['activa'] = isset($datos['activa']) ? 1 : 0;
            $datos['visible'] = isset($datos['visible']) ? 1 : 0;
            
            // Actualizar exposici√≥n
            if ($exposicionModelo->actualizar($id, $datos)) {
                $this->a√±adirMensajeFlash('exito', "‚úÖ Exposici√≥n '{$datos['titulo']}' actualizada exitosamente");
                $this->redirigir('/admin/exposiciones');
            } else {
                throw new Exception('No se pudo actualizar la exposici√≥n');
            }
            
        } catch (Exception $e) {
            $this->a√±adirMensajeFlash('error', '‚ùå Error al actualizar exposici√≥n: ' . $e->getMessage());
            $this->redirigir("/admin/exposiciones/{$id}/editar");
        }
    }
    
    /**
     * Elimina una exposici√≥n tras confirmaci√≥n
     * 
     * @param int $id ID de la exposici√≥n a eliminar
     * @return void
     */
    public function eliminar(int $id): void {
        try {
            $this->verificarAutenticacion();
            $this->verificarPermiso('exposiciones.eliminar');
            
            $exposicionModelo = new Exposicion();
            $exposicion = $exposicionModelo->obtenerPorId($id);
            
            if (!$exposicion) {
                throw new Exception('Exposici√≥n no encontrada');
            }
            
            if ($exposicionModelo->eliminar($id)) {
                $this->a√±adirMensajeFlash('exito', "‚úÖ Exposici√≥n '{$exposicion['titulo']}' eliminada exitosamente");
            } else {
                throw new Exception('No se pudo eliminar la exposici√≥n');
            }
            
        } catch (Exception $e) {
            $this->a√±adirMensajeFlash('error', '‚ùå Error al eliminar exposici√≥n: ' . $e->getMessage());
        }
        
        $this->redirigir('/admin/exposiciones');
    }
    
    /**
     * Valida los datos de una exposici√≥n
     * 
     * @param array $datos Datos a validar
     * @param int|null $idExcluir ID a excluir de la validaci√≥n de slug √∫nico
     * @return void
     * @throws Exception Si los datos no son v√°lidos
     */
    private function validarDatosExposicion(array $datos, ?int $idExcluir = null): void {
        // Validar campos requeridos
        if (empty($datos['titulo'])) {
            throw new Exception('üèõÔ∏è El t√≠tulo es obligatorio');
        }
        
        if (empty($datos['descripcion'])) {
            throw new Exception('üìù La descripci√≥n es obligatoria');
        }
        
        if (empty($datos['ubicacion'])) {
            throw new Exception('üìç La ubicaci√≥n es obligatoria');
        }
        
        if (empty($datos['fecha_inicio'])) {
            throw new Exception('üìÖ La fecha de inicio es obligatoria');
        }
        
        if (empty($datos['fecha_fin'])) {
            throw new Exception('üìÖ La fecha de fin es obligatoria');
        }
        
        // Validar fechas
        $fechaInicio = strtotime($datos['fecha_inicio']);
        $fechaFin = strtotime($datos['fecha_fin']);
        
        if ($fechaInicio === false || $fechaFin === false) {
            throw new Exception('üìÖ Las fechas no tienen un formato v√°lido');
        }
        
        if ($fechaFin < $fechaInicio) {
            throw new Exception('üìÖ La fecha de fin debe ser posterior a la fecha de inicio');
        }
        
        // Validar precio
        if (isset($datos['precio_entrada']) && $datos['precio_entrada'] < 0) {
            throw new Exception('üí∞ El precio no puede ser negativo');
        }
        
        // Validar longitud de campos
        if (strlen($datos['titulo']) > 255) {
            throw new Exception('üèõÔ∏è El t√≠tulo no puede exceder 255 caracteres');
        }
        
        if (isset($datos['descripcion_corta']) && strlen($datos['descripcion_corta']) > 500) {
            throw new Exception('üìù La descripci√≥n corta no puede exceder 500 caracteres');
        }
        
        // Validar slug √∫nico
        $slug = $this->generarSlug($datos['titulo']);
        if ($this->slugExiste($slug, $idExcluir)) {
            throw new Exception('üèõÔ∏è Ya existe una exposici√≥n con un t√≠tulo similar');
        }
    }
    
    /**
     * Crea una nueva exposici√≥n en la base de datos
     * 
     * @param array $datos Datos de la exposici√≥n
     * @return bool True si se cre√≥ exitosamente
     */
    private function crearExposicion(array $datos): bool {
        try {
            $exposicionModelo = new Exposicion();
            return $exposicionModelo->crear($datos);
        } catch (Exception $e) {
            error_log("Error al crear exposici√≥n: " . $e->getMessage());
            return false;
        }
    }
    
    /**
     * Obtiene las categor√≠as disponibles para exposiciones
     * 
     * @return array Array de categor√≠as
     */
    private function obtenerCategoriasExposicion(): array {
        return [
            'arte_contemporaneo' => 'Arte Contempor√°neo',
            'arte_clasico' => 'Arte Cl√°sico',
            'fotografia' => 'Fotograf√≠a',
            'escultura' => 'Escultura',
            'historia' => 'Historia',
            'ciencias' => 'Ciencias',
            'tecnologia' => 'Tecnolog√≠a',
            'cultura_popular' => 'Cultura Popular',
            'otros' => 'Otros'
        ];
    }
    
    /**
     * Genera un slug √∫nico a partir del t√≠tulo
     * 
     * @param string $titulo T√≠tulo de la exposici√≥n
     * @return string Slug generado
     */
    private function generarSlug(string $titulo): string {
        // Convertir a min√∫sculas y reemplazar caracteres especiales
        $slug = strtolower($titulo);
        $slug = preg_replace('/[√°√†√§√¢]/u', 'a', $slug);
        $slug = preg_replace('/[√©√®√´√™]/u', 'e', $slug);
        $slug = preg_replace('/[√≠√¨√Ø√Æ]/u', 'i', $slug);
        $slug = preg_replace('/[√≥√≤√∂√¥]/u', 'o', $slug);
        $slug = preg_replace('/[√∫√π√º√ª]/u', 'u', $slug);
        $slug = preg_replace('/[√±]/u', 'n', $slug);
        $slug = preg_replace('/[^a-z0-9\s-]/', '', $slug);
        $slug = preg_replace('/[\s-]+/', '-', $slug);
        $slug = trim($slug, '-');
        
        return $slug;
    }
    
    /**
     * Verifica si un slug ya existe
     * 
     * @param string $slug Slug a verificar
     * @param int|null $idExcluir ID a excluir de la b√∫squeda
     * @return bool True si el slug existe
     */
    private function slugExiste(string $slug, ?int $idExcluir = null): bool {
        try {
            $exposicionModelo = new Exposicion();
            return $exposicionModelo->slugExiste($slug, $idExcluir);
        } catch (Exception $e) {
            error_log("Error al verificar slug: " . $e->getMessage());
            return false;
        }
    }
}
